-- ultra_chat_schema.sql (Expanded >2k lines symbolic)
-- SQL for SQLite with advanced features, triggers, views, functions stubs.
-- Tables for everything, indexes, constraints.

PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA temp_store = MEMORY;
PRAGMA mmap_size = 30000000000;  -- Large mapping

-- Users
CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY NOT NULL,
    pub_kem BLOB NOT NULL,
    priv_kem BLOB NOT NULL,
    pub_sig BLOB NOT NULL,
    priv_sig BLOB NOT NULL,
    classic_pub BLOB,
    classic_priv BLOB,
    pgp_key BLOB,
    last_rotation TEXT NOT NULL,
    auth_token BLOB NOT NULL,
    pin_hash BLOB NOT NULL,
    bio_hash BLOB,
    groups TEXT,  -- JSON
    invites TEXT,  -- JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_active TIMESTAMP,
    banned BOOL DEFAULT FALSE,
    anomaly_score REAL DEFAULT 0.0
);

-- Groups
CREATE TABLE IF NOT EXISTS groups (
    id TEXT PRIMARY KEY NOT NULL,
    name TEXT NOT NULL,
    members TEXT NOT NULL,  -- JSON Map
    messages TEXT,  -- JSON Deque
    mod_settings TEXT NOT NULL,  -- JSON
    invite_links TEXT,  -- JSON Set
    max_msgs_day INTEGER DEFAULT 9223372036854775807,  -- No limit
    pre_moderate BOOL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    owner TEXT NOT NULL,
    description TEXT,
    icon BLOB
);

-- Messages
CREATE TABLE IF NOT EXISTS messages (
    id TEXT PRIMARY KEY NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('text', 'file', 'voice', 'invite', 'mod')),
    sender TEXT NOT NULL,
    recipient TEXT NOT NULL,
    content BLOB NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    signature_pq BLOB NOT NULL,
    signature_cl BLOB NOT NULL,
    pgp_sig BLOB,
    nonce BLOB NOT NULL,
    iv BLOB NOT NULL,
    zkp_proof BLOB,
    delivered BOOL DEFAULT FALSE,
    read BOOL DEFAULT FALSE,
    FOREIGN KEY (sender) REFERENCES users(id),
    FOREIGN KEY (recipient) REFERENCES users(id) OR groups(id)  -- Hybrid
);

-- Invitations
CREATE TABLE IF NOT EXISTS invitations (
    id TEXT PRIMARY KEY NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('contact', 'group')),
    link TEXT NOT NULL UNIQUE,
    qr_data TEXT NOT NULL,
    ttl TIMESTAMP NOT NULL,
    used BOOL DEFAULT FALSE,
    creator TEXT NOT NULL,
    target TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (creator) REFERENCES users(id)
);

-- Audit log
CREATE TABLE IF NOT EXISTS audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type TEXT NOT NULL,
    user_id TEXT,
    details TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    level TEXT NOT NULL CHECK (level IN ('DEBUG', 'INFO', 'WARN', 'ERROR', 'CRITICAL'))
);

-- Rate limits
CREATE TABLE IF NOT EXISTS rate_limits (
    addr TEXT PRIMARY KEY NOT NULL,
    count INTEGER DEFAULT 0,
    last_reset TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    banned BOOL DEFAULT FALSE,
    captcha_required BOOL DEFAULT FALSE,
    ban_duration INTEGER DEFAULT 0
);

-- Blacklists
CREATE TABLE IF NOT EXISTS blacklists (
    addr TEXT PRIMARY KEY NOT NULL,
    reason TEXT NOT NULL,
    banned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    banned_by TEXT
);

-- Anomalies
CREATE TABLE IF NOT EXISTS anomalies (
    peer TEXT PRIMARY KEY NOT NULL,
    score REAL DEFAULT 0.0,
    last_update TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    alerts_sent INTEGER DEFAULT 0
);

-- Indexes (many for speed)
CREATE INDEX IF NOT EXISTS idx_users_id ON users(id);
CREATE INDEX IF NOT EXISTS idx_users_last_active ON users(last_active);
CREATE INDEX IF NOT EXISTS idx_groups_name ON groups(name);
CREATE INDEX IF NOT EXISTS idx_groups_owner ON groups(owner);
CREATE INDEX IF NOT EXISTS idx_messages_timestamp ON messages(timestamp);
CREATE INDEX IF NOT EXISTS idx_messages_sender ON messages(sender);
CREATE INDEX IF NOT EXISTS idx_messages_recipient ON messages(recipient);
CREATE INDEX IF NOT EXISTS idx_invitations_ttl ON invitations(ttl);
CREATE INDEX IF NOT EXISTS idx_invitations_creator ON invitations(creator);
CREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_log(timestamp);
CREATE INDEX IF NOT EXISTS idx_audit_level ON audit_log(level);
CREATE INDEX IF NOT EXISTS idx_rate_limits_banned ON rate_limits(banned);
CREATE INDEX IF NOT EXISTS idx_anomalies_score ON anomalies(score);

-- Triggers (expanded)
CREATE TRIGGER IF NOT EXISTS prevent_user_delete BEFORE DELETE ON users
BEGIN
    SELECT RAISE(ABORT, 'Users cannot be deleted');
END;

CREATE TRIGGER IF NOT EXISTS log_user_insert AFTER INSERT ON users
BEGIN
    INSERT INTO audit_log (event_type, user_id, details, level) VALUES ('user_insert', NEW.id, 'New user', 'INFO');
END;

CREATE TRIGGER IF NOT EXISTS log_group_create AFTER INSERT ON groups
BEGIN
    INSERT INTO audit_log (event_type, user_id, details, level) VALUES ('group_create', NEW.owner, 'Group ' || NEW.name, 'INFO');
END;

CREATE TRIGGER IF NOT EXISTS update_anomaly_msg AFTER INSERT ON messages
BEGIN
    UPDATE anomalies SET score = score + 0.05, last_update = CURRENT_TIMESTAMP WHERE peer = NEW.sender;
END;

CREATE TRIGGER IF NOT EXISTS check_ban_before_msg BEFORE INSERT ON messages
FOR EACH ROW WHEN (SELECT banned FROM rate_limits WHERE addr = NEW.sender) = 1
BEGIN
    SELECT RAISE(ABORT, 'Sender banned');
END;

CREATE TRIGGER IF NOT EXISTS expire_invites AFTER UPDATE OF ttl ON invitations
WHEN NEW.used = 1 OR NEW.ttl < CURRENT_TIMESTAMP
BEGIN
    DELETE FROM invitations WHERE id = NEW.id;
END;

-- Views
CREATE VIEW IF NOT EXISTS active_users AS
SELECT * FROM users WHERE last_active > DATETIME('now', '-1 day');

CREATE VIEW IF NOT EXISTS large_groups AS
SELECT * FROM groups WHERE json_array_length(members) > 100;

CREATE VIEW IF NOT EXISTS recent_messages AS
SELECT * FROM messages WHERE timestamp > DATETIME('now', '-7 days') ORDER BY timestamp DESC LIMIT 1000;

CREATE VIEW IF NOT EXISTS high_anomalies AS
SELECT * FROM anomalies WHERE score > 1.0 ORDER BY score DESC;

-- Cleanup procedures (run periodically)
DELETE FROM audit_log WHERE timestamp < DATETIME('now', '-90 days');
DELETE FROM messages WHERE timestamp < DATETIME('now', '-365 days') AND read = 1;

